مشکل از لاگ‌ها معلومه: سرورت رو **پورت ۵۰۰۰** بالا می‌آد، ولی Replit فقط سرویسی رو نشون می‌ده که روی **`$PORT`** گوش می‌ده. برای همین یه‌بار درست می‌شه، بعد دوباره می‌ره رو “example domain”. این پرامپت رو همون‌طور که هست بده به Replit AI تا سفت‌وسخت فیکسش کنه:

---

# 🔧 Replit AI — Hard-Fix: Bind to `$PORT`, Single Public Listener

**Do NOT edit `vite.config.ts`.**
Only **one** public listener on **`0.0.0.0:$PORT`** (Uvicorn). React is served from `dist/`. All client API calls are **relative** (`/api/v1`).

## 1) Clean run command & bind to `$PORT`

* Open `.replit` and set:

```
run = "npm run dev"
```

* In `package.json`, overwrite scripts to:

```json
{
  "scripts": {
    "dev": "concurrently -k \"vite build --watch\" \"uvicorn app.main:app --host 0.0.0.0 --port $PORT\"",
    "build": "vite build",
    "preview": "vite preview --host --port $PORT"
  }
}
```

* 🔍 Remove any other scripts that bind to 5000 (e.g. `"python3 -m http.server 5000"`).
* 🔎 Replace every hardcoded `5000` in the repo:
  Run `grep -R "5000" -n .` and fix them to **`$PORT`** (ignore comments).

## 2) FastAPI must serve the whole `dist/` at `/`

Replace `app/main.py` with:

```py
import os
from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI()

@app.get("/api/v1/health")
def health():
    return {"ok": True}

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"], allow_methods=["*"], allow_headers=["*"],
)

# Serve SPA at root so /app-config.json and assets work
if os.path.isdir("dist"):
    app.mount("/", StaticFiles(directory="dist", html=True), name="spa")

# ⚠️ Remove any manual catch-all (@app.get("/{path:path}")) you had before.
# The StaticFiles(html=True) already returns index.html for SPA routes.
```

## 3) Frontend runtime config (no localhost)

* Ensure `public/app-config.json`:

```json
{ "API_BASE": "/api/v1" }
```

* In code, **never** call `http://localhost:8000`. Use a single helper that prefixes `/api/v1`.

## 4) Build once and run

* In the Shell:

```
rm -rf dist
npm run build
```

* Press **Run** (which runs `npm run dev`):

  * You should see:

    * `vite ... build ... (watching)`
    * `Uvicorn running on http://0.0.0.0:$PORT`
* Open your Replit URL:

  * `/` → loads React UI from `dist/`
  * `/api/v1/health` → `{"ok": true}`

## 5) Sanity checks (debug if needed)

* Print the port: `echo PORT=$PORT` (must be non-empty).
* Check no one binds 5000: `grep -R "5000" -n .` should show nothing active.
* If you still get the example page, your Run command is not `npm run dev`. Re-open `.replit` and fix `run` exactly as above.

**Acceptance:** No “example domain”, UI renders, `/app-config.json` serves JSON (not HTML), `/api/v1/health` is OK, and Uvicorn always logs `0.0.0.0:$PORT` (not 5000).

---

اگر همین رو انجام بدی و باز هم مشکل بود، خروجی `.replit`، محتویات `package.json` فعلی و نتیجه‌ی `grep -R "5000" -n .` رو بده تا دقیق همون فایل خاطی رو نشونه بگیرم.
