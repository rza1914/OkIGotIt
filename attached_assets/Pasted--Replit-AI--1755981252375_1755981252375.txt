Ø¨Ø§Ø´Ù‡â€”Ø§ÛŒÙ† Â«Ù¾Ø±Ø§Ù…Ù¾Øª Ø³ÙˆÙ¾Ø±â€ŒØ¯ÛŒâ€ŒØªÛŒÙ„Ø¯Â» Ø±Ùˆ Ø¹ÛŒÙ†Ø§Ù‹ Ø¨Ø¯Ù‡ Ø¨Ù‡ Replit AI ØªØ§ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ù‚Ø·Ø¹ÛŒ Ù…Ø´Ú©Ù„ Â«Ù„ÛŒÙ†Ú© Ø¨Ù‡ Ø¯Ø§Ù…ÛŒÙ† Ù†Ù…ÙˆÙ†Ù‡/Ø®Ø§Ù„ÛŒÂ» Ø±Ùˆ Ø­Ù„ Ú©Ù†Ù‡. Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ: Ø§ÙˆÙ„ **Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„Ù Ù‚Ø§Ø¨Ù„â€ŒØ§Ø·Ù…ÛŒÙ†Ø§Ù†** (ØªÚ©â€ŒÙ¾ÙˆØ±Øª ÙÙ‚Ø· Ø¨Ø§ FastAPI + ÛŒÚ© HTML Ø³Ø§Ø¯Ù‡) Ø±Ùˆ Ø¨Ø§Ù„Ø§ Ù…ÛŒâ€ŒØ¢Ø±ÛŒÙ… ØªØ§ Ù…Ø·Ù…Ø¦Ù† Ø¨Ø´ÛŒÙ… Ù„ÛŒÙ†Ú© Replit Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³ Ø¯Ø±Ø³Øª Ù…ÛŒâ€ŒØ®ÙˆØ±Ù‡Ø› Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ **React Ø¨ÛŒÙ„Ø¯** Ø±Ùˆ ÙˆØµÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…. Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¯Ø± `vite.config.ts` Ù†Ø¯Ù‡.

---

# ğŸ”§ Replit AI â€” Force-Fix Empty Domain (Single Port Sanity â†’ React Attach)

**Hard constraints:**

* â—ï¸Do **NOT** edit `vite.config.ts`.
* One public listener only: **Uvicorn on `0.0.0.0:$PORT`**.
* Frontend must hit API with **relative base** (`/api/v1`), never `http://localhost...`.

## Phase 1 â€” Sanity server (prove URL works)

1. **Overwrite** `app/main.py` with a tiny FastAPI app that serves a static â€œHelloâ€ at `/` and a health endpoint:

```py
from fastapi import FastAPI
from fastapi.responses import HTMLResponse, JSONResponse

app = FastAPI()

@app.get("/api/v1/health")
def health():
    return {"ok": True}

@app.get("/", response_class=HTMLResponse)
def index():
    return """<!doctype html>
<html lang="fa" dir="rtl">
  <head><meta charset="utf-8"><title>iShop Sanity</title></head>
  <body style="font-family: sans-serif">
    <h1>âœ… iShop Sanity</h1>
    <p>Ø§Ú¯Ø± Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø±Ø§ Ù…ÛŒâ€ŒØ¨ÛŒÙ†ÛŒ ÛŒØ¹Ù†ÛŒ Ø³Ø±ÙˆØ± Ø±ÙˆÛŒ <b>$PORT</b> Ø¨Ø§Ù„Ø§ Ø§Ø³Øª.</p>
    <p>Ù‡ÙÙ„Ø«: <a href="/api/v1/health">/api/v1/health</a></p>
  </body>
</html>"""
```

2. **Temporarily change** `package.json` scripts to a deterministic single command (Ø¨Ø¯ÙˆÙ† watch Ùˆ Ø¨Ø¯ÙˆÙ† Vite):

```json
{
  "scripts": {
    "dev": "uvicorn app.main:app --host 0.0.0.0 --port $PORT",
    "build": "vite build",
    "preview": "vite preview --host --port $PORT"
  }
}
```

3. **Run**: set Replit â€œRunâ€ to `npm run dev`.

   * Ø¨Ø§Ø² Ú©Ù†: `<your-replit-url>/` â†’ Ø¨Ø§ÛŒØ¯ Ù‡Ù…ÙˆÙ† â€œâœ… iShop Sanityâ€ Ø±Ùˆ Ø¨Ø¨ÛŒÙ†ÛŒ.
   * Ø¨Ø§Ø² Ú©Ù†: `<your-replit-url>/api/v1/health` â†’ Ø¨Ø§ÛŒØ¯ `{"ok":true}` Ø¨Ø¯Ù‡.

> Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Â«Ø¯Ø§Ù…ÛŒÙ† Ù†Ù…ÙˆÙ†Ù‡/Ø®Ø§Ù„ÛŒÂ» Ù…ÛŒâ€ŒØ¨ÛŒÙ†ÛŒ: ÛŒØ¹Ù†ÛŒ Ù‡ÛŒÚ†â€ŒÚ©Ø³ Ø±ÙˆÛŒ `$PORT` Ú¯ÙˆØ´ Ù†Ù…ÛŒâ€ŒØ¯Ù‡ ÛŒØ§ Run command Ú†ÛŒØ² Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ø¯Ø± Ø§ÛŒÙ† ØµÙˆØ±Øª:

* Ù„Ø§Ú¯ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡ Ùˆ Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ±Ø§Øª Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù† ØªØ§ ØªØ´Ø®ÛŒØµ Ø¯Ù‡ÛŒÙ…:
  `echo PORT=$PORT`
  `ps -ef | grep -E "uvicorn|node|vite|python" | grep -v grep`
  (Ø¨Ø§ÛŒØ¯ ÛŒÚ© Uvicorn Ø¨Ø§ `--host 0.0.0.0 --port $PORT` Ø¨Ø¨ÛŒÙ†ÛŒÙ….)

## Phase 2 â€” Attach React build to FastAPI

ÙˆÙ‚ØªÛŒ Phase 1 Ø¯Ø±Ø³Øª Ø¨ÙˆØ¯ØŒ Ø­Ø§Ù„Ø§ React Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØµÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø¨Ø¯ÙˆÙ† Ø§ÛŒÙ†Ú©Ù‡ Ù…Ø´Ú©Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾ÙˆØ±Øª Ù¾ÛŒØ´ Ø¨ÛŒØ§ÛŒØ¯.

1. **Create dist placeholder** (ÙÙ‚Ø· Ø§Ú¯Ø± build Ù†Ø¯Ø§Ø±ÛŒØŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² 404):
   Ø¨Ø³Ø§Ø²: `dist/index.html` Ø¨Ø§ ÛŒÚ© HTML Ø³Ø§Ø¯Ù‡ (Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø² Ù‡Ù…ÙˆÙ† Sanity HTML Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒ).

2. **Update** `app/main.py` to serve `dist` + SPA fallback (health Ø­ÙØ¸ Ø´ÙˆØ¯):

```py
import os
from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from starlette.responses import FileResponse, JSONResponse

app = FastAPI()

@app.get("/api/v1/health")
def health():
    return {"ok": True}

# Serve built frontend
if os.path.isdir("dist"):
    if os.path.isdir("dist/assets"):
        app.mount("/assets", StaticFiles(directory="dist/assets"), name="assets")
    app.mount("/_app", StaticFiles(directory="dist"), name="dist_root")

@app.get("/{path:path}")
def spa(path: str):
    index_path = os.path.join("dist", "index.html")
    if os.path.exists(index_path):
        return FileResponse(index_path)
    return JSONResponse({"detail": "Frontend not built yet. Run npm run build"}, status_code=503)
```

3. **Runtime API base** Ø±Ø§ Ù…Ø·Ù…Ø¦Ù† Ú©Ù† **Ù†Ø³Ø¨ÛŒ** Ø§Ø³Øª:
   `public/app-config.json`:

```json
{ "API_BASE": "/api/v1" }
```

Ùˆ Ø¯Ø± Ú©Ø¯ React ÙÙ‚Ø· Ø§Ø² helper Ø®ÙˆØ¯Øª (Ù…Ø«Ù„Ø§Ù‹ `api('/products')`) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ØŒ Ù†Ù‡ Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù…Ø·Ù„Ù‚ Ù…Ø«Ù„ `http://localhost:8000`.

4. **Test build** (ÛŒÚ©â€ŒØ¨Ø§Ø± Ø¯Ø³ØªÛŒ):
   Ø¯Ø± Shell:

   ```
   npm run build
   ```

   Ø¨Ø¹Ø¯ **Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±** Ø¯Ø± RunØŒ Ù‡Ù†ÙˆØ² `npm run dev` Ø¨Ø§ÛŒØ¯ Ù‡Ù…Ø§Ù† Uvicorn Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†Ø¯ Ùˆ Ø§Ù„Ø§Ù† Ø§Ø² `dist` Ù„ÙˆØ¯ Ú©Ù†Ø¯.
   ØµÙØ­Ù‡ Ù‡ÙˆÙ… React Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ§ÛŒØ¯Ø› `/api/v1/health` Ù‡Ù… Ø¨Ø§ÛŒØ¯ Ú©Ø§Ø± Ú©Ù†Ø¯.

## Phase 3 â€” (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) Watch Ø®ÙˆØ¯Ú©Ø§Ø±

ÙˆÙ‚ØªÛŒ Ù…Ø·Ù…Ø¦Ù† Ø´Ø¯ÛŒ Ù„ÛŒÙ†Ú© Replit Ø¯Ø±Ø³Øª Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯:

* Ø§Ú¯Ø± Watch Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø¨Ø¯ÙˆÙ† HMR:

```json
{
  "scripts": {
    "dev": "concurrently -k \"vite build --watch\" \"uvicorn app.main:app --host 0.0.0.0 --port $PORT\"",
    "build": "vite build",
    "preview": "vite preview --host --port $PORT"
  }
}
```

* Ø§Ú¯Ø± ÙØ¹Ù„Ø§Ù‹ ÙÙ‚Ø· Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØŒ Ù‡Ù…Ø§Ù† `"dev": "uvicorn ..."` + Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ `npm run build` Ù‚Ø¨Ù„ Ø§Ø² ØªØ³Øª Ú©Ø§ÙÛŒ Ø§Ø³Øª.

## Guardrails & Pitfalls

* **ÙÙ‚Ø· ÛŒÚ© Ø³Ø±ÙˆÛŒØ³** Ø¨Ø§ÛŒØ¯ Ø±ÙˆÛŒ `$PORT` Ú¯ÙˆØ´ Ø¨Ø¯Ù‡Ø¯: Uvicorn. Ù‡ÛŒÚ† Node/Vite/proxy Ø¯ÛŒÚ¯Ø±ÛŒ Ù†Ø¨Ø§ÛŒØ¯ Ø±ÙˆÛŒ `$PORT` Ø¨Ø§Ø´Ø¯.
* Ø§Ú¯Ø± Ø³Ø¨Ø¯/Ù…ÙˆØ¯Ø§Ù„/â€¦ Ø§Ø² `http://localhost:8000` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯ØŒ **Ù‡Ù…Ù‡** Ø±Ø§ Ø¨Ù‡ `/api/v1` Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†.
* Ø§Ú¯Ø± ØµÙØ­Ù‡ Ø®Ø§Ù„ÛŒ ÙˆÙ„ÛŒ health ok Ø§Ø³Øª â†’ ÛŒØ¹Ù†ÛŒ `dist/index.html` Ù†ÛŒØ³Øª ÛŒØ§ build fail Ø´Ø¯Ù‡. Ø§ÙˆÙ„ `npm run build` Ùˆ Ù„Ø§Ú¯ Vite Ø±Ø§ Ú†Ú© Ú©Ù†.
* Ø§Ú¯Ø± React Ù…ÛŒâ€ŒØ¢ÛŒØ¯ ÙˆÙ„ÛŒ API Ø®Ø·Ø§ÛŒ CORS Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ â†’ ÛŒØ¹Ù†ÛŒ Ø¬Ø§ÛŒÛŒ Ù‡Ù†ÙˆØ² Ø¨Ù‡ Ø¯Ø§Ù…Ù†Ù‡â€ŒÛŒ Ø¯ÛŒÚ¯Ø±ÛŒ Ù…ÛŒâ€ŒØ²Ù†ÛŒØ› Ù‡Ù…Ù‡ Ø¬Ø§ Ø¨Ø§ÛŒØ¯ Ù†Ø³Ø¨ÛŒ Ø¨Ø§Ø´Ø¯ (`/api/v1/...`).

---

**Outcome Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±:**

* Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† URL Replit â†’ Ù‡Ù…ÛŒØ´Ù‡ ÛŒØ§ Sanity HTML Ø±Ø§ Ù…ÛŒâ€ŒØ¨ÛŒÙ†ÛŒ (Phase 1) ÛŒØ§ UI React Ø§Ø² `dist` (Phase 2/3).
* `/api/v1/health` â†’ âœ…
* Ù‡ÛŒÚ† Â«example domainÂ» ÛŒØ§ Â«Ø³Ø±ÙˆØ±Ù‡Ø§ Ø®Ø§Ù…ÙˆØ´Â» Ø¯ÛŒØ¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ú†ÙˆÙ† **Uvicorn Ø±ÙˆÛŒ `0.0.0.0:$PORT`** Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø²Ù†Ø¯Ù‡ Ø§Ø³Øª.
