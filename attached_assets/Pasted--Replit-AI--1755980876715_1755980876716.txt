Ø§ÛŒÙ† Â«Ù¾Ø±Ø§Ù…Ù¾Øª Ø³ÙˆÙ¾Ø±â€ŒØ¯ÛŒâ€ŒØªÛŒÙ„Ø¯Â» Ø±Ùˆ Ø¹ÛŒÙ†Ø§Ù‹ Ø¨Ø¯Ù‡ Ø¨Ù‡ Replit AI ØªØ§ Ù…Ø´Ú©Ù„ Â«Ù„ÛŒÙ†Ú© Ø¨Ù‡ Ø¯Ø§Ù…ÛŒÙ† Ù†Ù…ÙˆÙ†Ù‡/Ø®Ø§Ù„ÛŒÂ» Ø¨Ø±Ø·Ø±Ù Ø¨Ø´Ù‡. Ø±Ø§Ù‡â€ŒØ­Ù„ Ù¾Ø§ÛŒØ¯Ø§Ø± Ø§ÛŒÙ†Ù‡ Ú©Ù‡ ÙÙ‚Ø· **ÛŒÚ© Ø³Ø±ÙˆÛŒØ³** Ø±ÙˆÛŒ **`0.0.0.0:$PORT`** Ú¯ÙˆØ´ Ø¨Ø¯Ù‡ (Uvicorn/FastAPI) Ùˆ ÙØ±Ø§Ù†Øª Ù‡Ù… Ø¨Ø§ **`vite build --watch`** Ù‡Ù…ÛŒØ´Ù‡ ØªØ§Ø²Ù‡ Ø¨Ù…ÙˆÙ†Ù‡. Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¯Ø± `vite.config.ts` Ø§Ù†Ø¬Ø§Ù… Ù†Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ….

---

# ğŸ”§ Replit AI â€” Reset & Fix: Single-Port Dev (FastAPI serves built React)

**Do NOT edit `vite.config.ts`.**
Frontend must call API with **relative base** (`/api/v1`) â€” Ù†Ù‡ `http://localhost...`.

## GOAL

* ÙÙ‚Ø· **Uvicorn/FastAPI** Ø±ÙˆÛŒ `0.0.0.0:$PORT` Ú¯ÙˆØ´ Ø¨Ø¯Ù‡ ØªØ§ Replit URL Ø¯Ø±Ø³Øª Ø¨Ø¯Ù‡.
* React Ø¨Ø§ `vite build --watch` Ø¨Ø§Ù†Ø¯Ù„ Ø´Ù‡ Ùˆ Ø§Ø² Ù…Ø³ÛŒØ± `dist/` ØªÙˆØ³Ø· FastAPI Ø³Ø±Ùˆ Ø¨Ø´Ù‡.
* `/api/v1/*` â†’ APIØŒ Ø³Ø§ÛŒØ± Ù…Ø³ÛŒØ±Ù‡Ø§ â†’ `dist/index.html` (SPA fallback).
* Ø§Ú¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø§Øª Ø¯Ø§Ø±ÛŒØŒ Ù‡Ù…Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§ Ø¨Ø´Ù‡ ÙˆÙ„ÛŒ **Ù¾ÙˆØ±Øª Ø¹Ù…ÙˆÙ…ÛŒ Ù†Ú¯ÛŒØ±Ù‡**.

---

## 1) Backend: Ø³Ø±Ùˆ `dist` + SPA fallback + health

**`app/main.py`** Ø±Ø§ Ø¨Ø³Ø§Ø²/Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†:

```py
import os
from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from starlette.responses import FileResponse, JSONResponse
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI()

# Dev: CORS Ø¨Ø§Ø² (Ø¯Ø± Ù¾Ø±ÙˆØ¯Ø§Ú©Ø´Ù† Ù…Ø­Ø¯ÙˆØ¯Ø´ Ú©Ù†)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/api/v1/health")
def health():
    return {"ok": True}

# Ø³Ø±Ùˆ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù†Ø¯Ù„â€ŒØ´Ø¯Ù‡
if os.path.isdir("dist"):
    if os.path.isdir("dist/assets"):
        app.mount("/assets", StaticFiles(directory="dist/assets"), name="assets")
    app.mount("/_app", StaticFiles(directory="dist"), name="dist_root")

# SPA fallback: Ù‡Ø±Ú†ÛŒ ØºÛŒØ± Ø§Ø² /api â†’ index.html
@app.get("/{full_path:path}")
def spa(full_path: str):
    index_path = os.path.join("dist", "index.html")
    if os.path.exists(index_path):
        return FileResponse(index_path)
    return JSONResponse({"detail": "Frontend not built yet. Run: npm run build"}, status_code=503)
```

---

## 2) Frontend Runtime Config (Ø¨Ø¯ÙˆÙ† Ù¾Ø±Ø§Ú©Ø³ÛŒ)

**`public/app-config.json`** Ø±Ø§ Ø¨Ø³Ø§Ø²:

```json
{ "API_BASE": "/api/v1" }
```

Ø§Ú¯Ø± loader Ù†Ø¯Ø§Ø±ÛŒØŒ Ø§ÛŒÙ† Ø¯Ùˆ ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†:

**`src/lib/runtimeConfig.ts`**

```ts
export type AppCfg = { API_BASE: string };
export async function loadRuntimeConfig(): Promise<AppCfg> {
  try {
    const r = await fetch('/app-config.json', { cache: 'no-store' });
    if (r.ok) return r.json();
  } catch {}
  return { API_BASE: '/api/v1' };
}
```

**`src/lib/api.ts`**

```ts
let cfg = { API_BASE: '/api/v1' };
export function setRuntimeCfg(c: { API_BASE: string }) { cfg = c; }

type FetchOpts = RequestInit & { auth?: boolean };
export async function api<T>(path: string, opts: FetchOpts = {}): Promise<T> {
  const url = `${cfg.API_BASE}${path}`;
  const headers: Record<string,string> = { 'Content-Type': 'application/json' };
  if (opts.auth) {
    const t = localStorage.getItem('token');
    if (t) headers.Authorization = `Bearer ${t}`;
  }
  const res = await fetch(url, { ...opts, headers: { ...headers, ...(opts.headers||{}) } });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json() as Promise<T>;
}
```

Ùˆ Ø¯Ø± **`src/main.tsx`** (Ø¨ÙˆØª):

```ts
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import { loadRuntimeConfig } from './lib/runtimeConfig';
import { setRuntimeCfg } from './lib/api';

loadRuntimeConfig().then(cfg => {
  setRuntimeCfg(cfg);
  ReactDOM.createRoot(document.getElementById('root')!).render(<App />);
});
```

> Ù‡Ø± Ø¬Ø§ Ø¢Ø¯Ø±Ø³ Ø«Ø§Ø¨Øª Ù…Ø«Ù„ `http://localhost:8000/api/v1` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ØŒ Ø­Ø°Ù Ùˆ ÙÙ‚Ø· Ø§Ø² helper `api('/...')` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯.

---

## 3) Scripts: ØªÚ©â€ŒÙ¾ÙˆØ±Øª Dev (Ø¨Ø¯ÙˆÙ† HMRØŒ ÙˆÙ„ÛŒ Ø²Ù†Ø¯Ù‡)

**`package.json`** Ø±Ø§ Ø§ÛŒÙ†â€ŒØ·ÙˆØ± ØªÙ†Ø¸ÛŒÙ… Ú©Ù†:

```json
{
  "scripts": {
    "dev": "concurrently -k \"vite build --watch\" \"uvicorn app.main:app --host 0.0.0.0 --port $PORT\"",
    "build": "vite build",
    "preview": "vite preview --host --port $PORT"
  },
  "devDependencies": {
    "concurrently": "^9.0.0"
  }
}
```

* **Run** Ø¯Ø± Replit = `npm run dev`
* Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡Ù†Ø¯:

  * `vite ... building for production... (watching)`
  * `Uvicorn running on http://0.0.0.0:$PORT`

> Ø§Ú¯Ø± **Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…** Ø¯Ø§Ø±ÛŒ Ùˆ Ù¾ÙˆØ±Øª Ù†Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒ:

```json
"dev": "concurrently -k \"vite build --watch\" \"uvicorn app.main:app --host 0.0.0.0 --port $PORT\" \"python -m bot.telegram_importer\""
```

---

## 4) Cleanup Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Replit

* Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ú†Ù†Ø¯ Ù¾Ø±ÙˆØ³Ù‡ Ø¯Ø§Ø´ØªÛŒ (Vite dev Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª Ø®ÙˆØ¯Ø´ØŒ Ù¾Ø±ÙˆÚ©Ø³ÛŒØŒ â€¦) Ù‡Ù…Ù‡ Ø±Ø§ Ø§Ø² scripts Ø­Ø°Ù Ú©Ù† ØªØ§ **ÙÙ‚Ø· Ø¯Ùˆ ØªØ§** Ø§Ø¬Ø±Ø§ Ø´ÙˆÙ†Ø¯: `vite build --watch` Ùˆ `uvicorn`.
* **Ù‡ÛŒÚ† Ø³Ø±ÙˆÛŒØ³ Ø¯ÛŒÚ¯Ø±ÛŒ** Ù†Ø¨Ø§ÛŒØ¯ Ø±ÙˆÛŒ `$PORT` Ø¨Ø¬Ø² Uvicorn Ú¯ÙˆØ´ Ø¨Ø¯Ù‡Ø¯.
* Ø§Ú¯Ø± Replit Deployment Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ: Entry Ø¨Ø§ÛŒØ¯ Ù‡Ù…ÛŒÙ† `npm run dev` ÛŒØ§ Ù…Ø¹Ø§Ø¯Ù„ Uvicorn Ø¨Ø§Ø´Ø¯ Ú©Ù‡ Ø±ÙˆÛŒ `$PORT` Ú¯ÙˆØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.

---

## 5) Acceptance (Ø¨Ø§ÛŒØ¯ Ù¾Ø§Ø³ Ø´ÙˆÙ†Ø¯)

* Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† URL Replit â†’ **ØµÙØ­Ù‡ ÙØ±Ø§Ù†Øª** Ø§Ø² `dist` Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
* Ø±ÙØªÙ† Ø¨Ù‡ `â€¦/api/v1/health` â†’ `{"ok": true}` Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ.
* ØªÙ…Ø§Ù… Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ù„Ø§ÛŒÙ†Øª Ø¨Ù‡ **Ù…Ø³ÛŒØ± Ù†Ø³Ø¨ÛŒ** `/api/v1/...` Ù…ÛŒâ€ŒØ®ÙˆØ±Ù†Ø¯ (Ù†Ù‡ localhostØŒ Ù†Ù‡ Ù¾ÙˆØ±Øª Ø¯ÛŒÚ¯Ø±).
* Ø±ÙØ±Ø´ Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ (Ù…Ø«Ù„ `/products/123`) â†’ SPA fallback Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
* Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¨Ù‡ `vite.config.ts` Ø§Ø¹Ù…Ø§Ù„ Ù†Ø´Ø¯Ù‡.

---

## 6) Ø§Ú¯Ø± Ø¨Ø¹Ø¯Ø§Ù‹ HMR Ø®ÙˆØ§Ø³ØªÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)

Ø¨Ø±Ø§ÛŒ HMR Ø¨Ø¯ÙˆÙ† Ø¯Ø³Øªâ€ŒØ²Ø¯Ù† Ø¨Ù‡ `vite.config.ts`ØŒ ÛŒÚ© **Express dev-proxy** Ø±ÙˆÛŒ `$PORT` Ø¨Ú¯Ø°Ø§Ø± Ú©Ù‡ `/api` Ø±Ø§ Ø¨Ù‡ `127.0.0.1:8000` Ùˆ Ø¨Ù‚ÛŒÙ‡ Ù…Ø³ÛŒØ±Ù‡Ø§ + WebSocket Ø±Ø§ Ø¨Ù‡ `127.0.0.1:5173` Ù¾Ø§Ø³ Ø¨Ø¯Ù‡Ø¯. (Ø§Ù„Ø§Ù† Ù„Ø§Ø²Ù… Ù†ÛŒØ³ØªØ› Ù…Ø¯Ù„ ØªÚ©â€ŒÙ¾ÙˆØ±Øª Ù¾Ø§ÛŒØ¯Ø§Ø±ØªØ± Ø§Ø³Øª Ùˆ Ù…Ø´Ú©Ù„ Â«Ø¯Ø§Ù…Ù†Ù‡ Ù†Ù…ÙˆÙ†Ù‡Â» Ø±Ø§ Ú©Ø§Ù…Ù„ Ø­Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.)

---

**ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø·Ù„Ø§ÛŒÛŒ:** Ù‡Ø± Ø¨Ø§Ø± Ø¯ÛŒØ¯ÛŒ Replit Ù„ÛŒÙ†Ú© Ø±Ø§ Ø¨Ù‡ Ø¯Ø§Ù…ÛŒÙ† Ø®Ø§Ù„ÛŒ Ù…ÛŒâ€ŒØ¨Ø±Ø¯ ÛŒØ¹Ù†ÛŒ Ù‡ÛŒÚ†â€ŒÚ©Ø³ Ø±ÙˆÛŒ `$PORT` Ú¯ÙˆØ´ Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ø¨Ø§ Ø§ÛŒÙ† Ù…Ø¯Ù„ØŒ Ù‡Ù…ÛŒØ´Ù‡ Uvicorn Ø±ÙˆÛŒ `$PORT` Ø±ÙˆØ´Ù† Ø§Ø³Øª Ùˆ Ù…Ø´Ú©Ù„ Ø¨Ø±Ø·Ø±Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.
